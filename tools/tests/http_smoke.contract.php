<?php

return [
    'defaults' => [
        'legacy_base_url' => getenv('SMOKE_LEGACY_BASE') ?: 'http://127.0.0.1:8080',
        'v2_base_url' => getenv('SMOKE_V2_BASE') ?: 'http://127.0.0.1:8081',
        'timeout_seconds' => 20,
    ],
    'fixtures' => [
        'HC_NUMBER' => getenv('SMOKE_HC_NUMBER') ?: 'HC-TEST-001',
        'BILLING_FORM_ID' => getenv('SMOKE_BILLING_FORM_ID') ?: '',
        'BILLING_HC_NUMBER' => getenv('SMOKE_BILLING_HC_NUMBER') ?: '',
    ],
    'modules' => [
        'dashboard' => [
            [
                'id' => 'dashboard_ui',
                'method' => 'GET',
                'legacy_path' => '/dashboard',
                'v2_path' => '/v2/dashboard',
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => [],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'v2_only',
                'notes' => 'Guest mode sends Accept: application/json, so v2 dashboard UI returns JSON 401.',
                'notes_auth' => 'Authenticated mode validates that /v2/dashboard renders HTML (status 200).',
            ],
            [
                'id' => 'dashboard_summary',
                'method' => 'GET',
                'legacy_path' => '/dashboard',
                'v2_path' => '/v2/dashboard/summary',
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => [
                    'data.patients_total',
                    'data.users_total',
                    'data.protocols_total',
                    'data.total_cirugias_periodo',
                    'data.procedimientos_dia.fechas',
                    'data.procedimientos_dia.totales',
                    'data.top_procedimientos.membretes',
                    'data.top_procedimientos.totales',
                    'data.revision_estados.incompletos',
                    'data.revision_estados.revisados',
                    'data.revision_estados.no_revisados',
                    'data.solicitudes_funnel.etapas',
                    'data.solicitudes_funnel.totales',
                    'data.crm_backlog.pendientes',
                    'meta.date_range.start',
                    'meta.date_range.end',
                    'meta.date_range.label',
                ],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'v2_only',
                'notes' => 'Guest mode validates auth requirement in v2 dashboard summary.',
                'notes_auth' => 'Authenticated mode validates dashboard v2 payload shape. Legacy status parity is skipped when UI cutover redirects /dashboard -> /v2/dashboard.',
            ],
        ],
        'billing' => [
            [
                'id' => 'billing_no_facturados',
                'method' => 'GET',
                'legacy_path' => '/api/billing/no-facturados?start=0&length=10',
                'v2_path' => '/v2/api/billing/no-facturados?start=0&length=10',
                'expect_status' => 200,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 200,
                'required_json_paths' => ['recordsTotal', 'recordsFiltered', 'data', 'summary.total'],
                'compare_mode' => 'v2_only',
                'notes' => 'Legacy returns 302 when unauthenticated. Run with --cookie=PHPSESSID=... for full parity.',
            ],
            [
                'id' => 'billing_afiliaciones',
                'method' => 'GET',
                'legacy_path' => '/api/billing/afiliaciones',
                'v2_path' => '/v2/api/billing/afiliaciones',
                'expect_status' => 200,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 200,
                'required_json_paths' => ['0'],
                'compare_mode' => 'v2_only',
                'notes' => 'Legacy returns 302 when unauthenticated. Run with --cookie=PHPSESSID=... for full parity.',
            ],
            [
                'id' => 'billing_no_facturados_crear',
                'method' => 'POST',
                'legacy_path' => '/billing/no-facturados/crear',
                'v2_path' => '/v2/billing/no-facturados/crear',
                'body_format' => 'form',
                'body' => [
                    'form_id' => '{BILLING_FORM_ID}',
                    'hc_number' => '{BILLING_HC_NUMBER}',
                ],
                'requires_dynamic_fixture' => true,
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 302,
                'expect_v2_status_auth' => 302,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => [],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'post_check_v2_auth' => [
                    'path' => '/v2/api/billing/no-facturados?start=0&length=10&busqueda={BILLING_FORM_ID}',
                    'method' => 'GET',
                    'expect_status' => 200,
                    'required_json_paths' => ['recordsFiltered', 'data'],
                    'assert_json_equals' => [
                        'recordsFiltered' => 0,
                    ],
                ],
                'notes' => 'Guest mode expects JSON 401 in v2 write endpoint.',
                'notes_auth' => 'Authenticated create expects redirect parity and validates the form is no longer pending in v2.',
            ],
            [
                'id' => 'billing_verificacion_derivacion',
                'method' => 'POST',
                'legacy_path' => '/api/billing/verificacion_derivacion.php',
                'v2_path' => '/v2/api/billing/verificacion_derivacion.php',
                'body_format' => 'form',
                'body' => [
                    'form_ids' => ['{BILLING_FORM_ID}'],
                ],
                'requires_dynamic_fixture' => true,
                'expect_status' => 401,
                'expect_legacy_status' => 200,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['success', 'error'],
                'required_json_paths_auth' => ['success', 'existentes', 'nuevos'],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'notes' => 'Guest mode validates v2 auth requirement on derivation verification.',
                'notes_auth' => 'Authenticated verification expects success payload with existentes/nuevos.',
            ],
            [
                'id' => 'billing_insertar_billing_main',
                'method' => 'POST',
                'legacy_path' => '/api/billing/insertar_billing_main.php',
                'v2_path' => '/v2/api/billing/insertar_billing_main.php',
                'body' => [
                    'procedimientos' => [
                        [
                            'form_id' => '{BILLING_FORM_ID}',
                            'hc_number' => '{BILLING_HC_NUMBER}',
                            'codigo' => '92012',
                            'detalle' => 'CONSULTA OFTALMOLOGICA DE CONTROL',
                            'procedimiento_proyectado' => 'SERVICIOS OFTALMOLOGICOS GENERALES - SER-OFT-005 - CONSULTA OFTALMOLOGICA DE CONTROL',
                            'doctor' => '',
                            'fecha' => '',
                            'hora' => '',
                            'sede_departamento' => '',
                            'id_sede' => null,
                            'afiliacion' => '',
                            'estado_agenda' => 'ATENDIDO',
                            'visita_id' => null,
                        ],
                    ],
                ],
                'requires_dynamic_fixture' => true,
                'expect_status' => 401,
                'expect_legacy_status' => 200,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['success', 'error'],
                'required_json_paths_auth' => ['procedimiento_proyectado', 'billing', 'errores'],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'post_check_v2_auth' => [
                    'path' => '/v2/api/billing/insertar_billing_main.php',
                    'method' => 'POST',
                    'expect_status' => 400,
                    'body_format' => 'json',
                    'required_json_paths' => ['success', 'error'],
                ],
                'notes' => 'Guest mode validates v2 auth requirement on insertar billing.',
                'notes_auth' => 'Authenticated insert expects structured success response and payload validation behavior.',
            ],
            [
                'id' => 'billing_eliminar_factura',
                'method' => 'POST',
                'legacy_path' => '/informes/api/eliminar-factura',
                'v2_path' => '/v2/informes/api/eliminar-factura',
                'body_format' => 'form',
                'body' => [
                    'form_id' => '{BILLING_FORM_ID}',
                ],
                'requires_dynamic_fixture' => true,
                'destructive' => true,
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['success', 'error'],
                'required_json_paths_auth' => ['success', 'message'],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'notes' => 'Guest mode validates v2 auth requirement on delete endpoint.',
                'notes_auth' => 'Destructive test: run only with --allow-destructive to validate delete flow.',
            ],
        ],
        'pacientes' => [
            [
                'id' => 'pacientes_datatable',
                'method' => 'POST',
                'legacy_path' => '/pacientes/datatable',
                'v2_path' => '/v2/pacientes/datatable',
                'body_format' => 'form',
                'body' => [
                    'draw' => 1,
                    'start' => 0,
                    'length' => 10,
                    'search' => ['value' => ''],
                ],
                'expect_status' => 401,
                'expect_legacy_status' => 401,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['draw', 'recordsTotal', 'recordsFiltered', 'data', 'error'],
                'required_json_paths_auth' => ['draw', 'recordsTotal', 'recordsFiltered', 'data'],
                'compare_mode' => 'full',
                'notes' => 'Guest parity: both legacy and v2 return 401. Use --cookie=PHPSESSID=... to validate authenticated parity.',
                'notes_auth' => 'Authenticated parity expects both legacy and v2 to return 200 with DataTable payload.',
            ],
            [
                'id' => 'pacientes_detalles',
                'method' => 'GET',
                'legacy_path' => '/pacientes/detalles?hc_number={HC_NUMBER}',
                'v2_path' => '/v2/pacientes/detalles?hc_number={HC_NUMBER}',
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => ['data.patientData.hc_number', 'data.timelineItems'],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'notes' => 'Legacy redirects unauthenticated users; v2 returns JSON 401 for API clients. With cookie, validate full patient context.',
                'notes_auth' => 'Run with --hc-number using an existing patient to validate authenticated patient context.',
            ],
            [
                'id' => 'pacientes_flujo',
                'method' => 'GET',
                'legacy_path' => '/pacientes/flujo?hc_number={HC_NUMBER}',
                'v2_path' => '/v2/pacientes/flujo?hc_number={HC_NUMBER}',
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 200,
                'expect_v2_status_auth' => 200,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => ['data', 'meta.count'],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'notes' => 'Legacy flujo is protected HTML; v2 flujo is protected JSON API.',
                'notes_auth' => 'Authenticated parity validates status parity and v2 flujo payload.',
            ],
            [
                'id' => 'pacientes_detalles_update',
                'method' => 'POST',
                'legacy_path' => '/pacientes/detalles?hc_number={HC_NUMBER}',
                'v2_path' => '/v2/pacientes/detalles?hc_number={HC_NUMBER}',
                'body_format' => 'form',
                'body' => [
                    'actualizar_paciente' => '1',
                ],
                'expect_status' => 401,
                'expect_legacy_status' => 302,
                'expect_v2_status' => 401,
                'expect_legacy_status_auth' => 302,
                'expect_v2_status_auth' => 302,
                'required_json_paths' => ['error'],
                'required_json_paths_auth' => [],
                'compare_mode' => 'v2_only',
                'compare_mode_auth' => 'status_only',
                'body_from_v2_json_auth' => [
                    'path' => '/v2/pacientes/detalles?hc_number={HC_NUMBER}',
                    'method' => 'GET',
                    'expect_status' => 200,
                    'required' => true,
                    'fields' => [
                        'fname' => 'data.patientData.fname',
                        'mname' => 'data.patientData.mname',
                        'lname' => 'data.patientData.lname',
                        'lname2' => 'data.patientData.lname2',
                        'afiliacion' => 'data.patientData.afiliacion',
                        'fecha_nacimiento' => 'data.patientData.fecha_nacimiento',
                        'sexo' => 'data.patientData.sexo',
                        'celular' => 'data.patientData.celular',
                    ],
                ],
                'post_check_v2_auth' => [
                    'path' => '/v2/pacientes/detalles?hc_number={HC_NUMBER}',
                    'method' => 'GET',
                    'expect_status' => 200,
                    'required_json_paths' => ['data.patientData.hc_number'],
                    'assert_json_equals' => [
                        'data.patientData.fname' => '@body.fname',
                        'data.patientData.lname' => '@body.lname',
                        'data.patientData.afiliacion' => '@body.afiliacion',
                        'data.patientData.celular' => '@body.celular',
                    ],
                ],
                'notes' => 'Guest mode validates v2 unauthorized behavior for write endpoint.',
                'notes_auth' => 'Authenticated write parity checks status (302) and validates persisted patient fields in v2.',
            ],
        ],
        'auth' => [
            [
                'id' => 'auth_migration_status',
                'method' => 'GET',
                'legacy_path' => '/auth/login',
                'v2_path' => '/v2/auth/migration-status',
                'expect_status' => 501,
                'required_json_paths' => ['module', 'status', 'message'],
                'compare_mode' => 'v2_only',
            ],
        ],
    ],
];
